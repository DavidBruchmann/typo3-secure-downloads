[![Latest Stable Version](https://poser.pugx.org/bitmotion/secure-downloads/v/stable)](https://packagist.org/packages/bitmotion/secure-downloads)
[![Total Downloads](https://poser.pugx.org/bitmotion/secure-downloads/downloads)](https://packagist.org/packages/bitmotion/secure-downloads)
[![Latest Unstable Version](https://poser.pugx.org/bitmotion/secure-downloads/v/unstable)](https://packagist.org/packages/bitmotion/secure-downloads)
[![License](https://poser.pugx.org/bitmotion/secure-downloads/license)](https://packagist.org/packages/bitmotion/secure-downloads)

# Secure Downloads (secure_downloads)

## Introduction

### What does it do?
In TYPO3, assets like PDFs, TGZs or JPGs etc. are normally just referenced by a URL e.g. to `fileadmin/…`. 
The file itself is delivered directly by the web server, and is therefore not part of the TYPO3 access control 
scheme. Files remain unprotected, since URLs can be re-used, emailed, Google-included or even guessed.

The extension **“Secure Download” (secure_downloads)** changes this behavior: Files will now be accessed through 
a eID Script script that honors TYPO3 access rights. The converted URL's will then look like this:

    https://www.your-domain.de/index.php?eID=tx_securedownloads&p=1009&u=1053&g=1&t=1561234595&hash=98ee3d7670a48cfef464d6aeff2aed1ed46f5f34&file=/fileadmin/content/protected/sample.doc

This works regardless of where the files come from, is not limited to special plugins etc.

Since in most cases you will not want to protect everything (which means that everything undergoes rather 
performance-consuming access right checking), Secure Download is highly configurable. You may choose:

* what directories to protect (e.g. you can include `typo3temp/` or not,)
* what file types to protect (do you want to protect JPGs or not? etc.)
* what domains are considered local

As a complementary measure, you will of course need to configure your web server not to deliver these things 
directly (e.g. using `.htaccess` settings).

## Administration

All configuration of this extension is made in the Extension Manager.

### Extension configurations
<table>
	<tr>
		<th>Tab</th>
		<th>Option</th>
		<th>Type</th>
		<th>Description</th>
	</tr>
	<tr>
		<td>Basic</td>
		<td>cachetimeadd</td>
		<td>Integer</td>
		<td>The secure link is only valid for a limited time, which is calculated from the cache time that is used for the page that carries the link plus this value (in seconds). Default is 3600 sec (= 1 h).</td>
	</tr>
	<tr>
		<td></td>
		<td>linkFormat</td>
		<td>String</td>
		<td>The Format for the link generated by secure_downloads. You can change this if you apply appropriate mod_rewrite rules in your .htaccess file.</td>
	</tr>
	<tr>
		<td></td>
		<td>enableGroupCheck</td>
		<td>boolesch</td>
		<td>Allows forwarding a secure download link to others, who can access that file if they have at least one front-end user group in common. Enabling this makes the checks LESS restrictive!</td>
	</tr>
	<tr>
		<td></td>
		<td>groupCheckDirs</td>
		<td>String</td>
		<td>A list of directories for the less restrictive group check, separated by a pipe (|). Leave empty if you want to enable the group check for all directories.</td>
	</tr>
	<tr>
		<td></td>
		<td>excludeGroups</td>
		<td>String</td>
		<td>A comma separated list of groups that are excluded from the group check feature (if enabled).</td>
	</tr>
	<tr>
		<td></td>
		<td>domain</td>
		<td>String</td>
		<td>A domain prefix before the secured directories part (e.g. http://www.host.com/). Not needed for internal (relative) links.</td>
	</tr>
	<tr>
		<td></td>
		<td>securedDirs</td>
		<td>String</td>
		<td>What directories shall be protected? Multiple directory patterns can be separated by a pipe (|).</td>
	</tr>
	<tr>
		<td></td>
		<td>securedFiletypes</td>
		<td>String</td>
		<td>What file types (read: extensions) shall be protected? Multiple file extension patterns can be separated by a pipe (|).</td>
	</tr>
	<tr>
		<th></th>
		<th></th>
		<th></th>
		<th></th>
	</tr>
	<tr>
		<td>Filedelivery</td>
		<td>apacheDelivery</td>
		<td>boolesch</td>
		<td>Feature to deliver files through Apache not PHP (Beta)</td>
	</tr>
	<tr>
		<td></td>
		<td>forcedownload</td>
		<td>boolesch</td>
		<td>Force Download of specified filetypes</td>
	</tr>
	<tr>
		<td></td>
		<td>forcedownloadtype</td>
		<td>String</td>
		<td>A list of filetypes that should not be opened inline in a browser, seperated by a pipe. Only used if forcedownload is true.</td>
	</tr>
	<tr>
		<td></td>
		<td>additionalMimeTypes</td>
		<td>String</td>
		<td>Comma separated list of additional MIME types (file extension / mime type pairs, in which file extension and MIME type is separated by a pipe symbol). Can be used to override existing MIME type settings of the extension as well.</td>
	</tr>
	<tr>
		<td></td>
		<td>outputFunction</td>
		<td>String</td>
		<td>PHP function which is used to deliver the secured files (one of readfile, readfile_chunked, fpassthru).</td>
	</tr>
	<tr>
		<td></td>
		<td>outputChunkSize</td>
		<td>Integer</td>
		<td>Size of chunks to be delivered in one go (only relevant if "readfile_chunked" is used) (default: 1048576 Bytes)</td>
	</tr>
	<tr>
		<th></th>
		<th></th>
		<th></th>
		<th></th>
	</tr>
	<tr>
		<td>Module</td>
		<td>log</td>
		<td>boolesch</td>
		<td>Log each file access which will be shown in a Module 'Download traffic'</td>
	</tr>
	<tr>
		<th></th>
		<th></th>
		<th></th>
		<th></th>
	</tr>
	<tr>
		<td>Debug</td>
		<td>debug</td>
		<td>String</td>
		<td>Output each tag that maches the regex and will be replaced (default: 0)</td>
	</tr>
</table>

### Details on configuration evaluation
* The config fields *"securedDirs"*, *"filetype"* and *"domain"* allow regular expressions, but with limitations because some 
characters (slash, backslash, dot, blank) are automatically quoted for your convenience.
* For *"filetype"* (meaning actually the file extension), all upper/lowercase combinations are automatically included 
(e.g. "gif" would also cover "giF".)
* The `|` stands for "OR" .

#### Regex examples for securedDirs:

If for example you need to secure `fileadmin` and `typo3temp`, but not `uploads`:


    fileadmin|typo3temp


To secure everything under `fileadmin/secure` or `typo3temp`, you need to write:

    fileadmin/secure|typo3temp

You also can group some elements with regular expression, but you should be carefull with grouping because the complex 
regex in the extension does not work if some other matches were output by the regex. For grouping `( )` is used, 
but in our case you need to exclude the result of this `( )`. This can be done with `(?: )`. 

For example we need to find all under `fileadmin/secure1`, `fileadmin/secure2`, `fileadmin/secure3` or `typo3temp`:

    fileadmin/secure(?:1|2|3)|typo3temp

For the same need you can use also `[ ]` but all chars between `[ ]` are allowed here:

    fileadmin/secure[123]|typo3temp

If you need to exclude some subfolders in a secured directory you can do this by `(?! )`. For example like:

    (?!fileadmin/unsecured)fileadmin

More information can be found here: http://www.regular-expressions.info

### Access configuration

You also need to secure all the directories and filetypes by your server configuration. This can be done with 
`.htaccess` files. Some example `.htaccess` files can be found in the `Resources/Private/Examples` folder.

**Note:** This extension cannot secure links to files that you include in your CSS file. For example you can secure 
`/fileadmin` with the default `.htaccess_deny` file by putting the file in `/fileadmin`. You can allow 
`/fileadmin/templates/` with the default `.htaccess_allow` file by putting this file to `/fileadmin/template/`.


### Backend Module
Since version 1.0.0 this extensions contains a backend module. With this module you can show the summerized download 
traffic by a given timeframe for all users or by a frontend user. Since version 1.2.0 you will see all files and 
filesizes downloaded by specified users.

## Known Limitations / ToDo
* Get a hook for showpic.php – currently, there is none (thus xclassing necessary).
* Support for links from one PDF to another.
* Allow optional advanced mode for full Regex support.
* Images in Direct Mail newsletters, doesn't work correct with secure_dl :(
* Add a reST documentation.
